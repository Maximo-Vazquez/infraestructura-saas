apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-principal
  namespace: default  # Cambia si usas otro namespace para los servicios
  annotations:
    kubernetes.io/ingress.class: "nginx"  # Compatibilidad; la clase principal se define en spec.ingressClassName
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"  # Permite uploads de hasta 10MB
    nginx.ingress.kubernetes.io/ssl-redirect: "true"    # Redirige HTTP->HTTPS cuando el secreto TLS existe
spec:
  ingressClassName: nginx  # Debe coincidir con la IngressClass del Nginx Ingress Controller instalado
  tls:
    - hosts:
        - mi-nas-vaz.myqnapcloud.com           # Host base expuesto por QNAP
        - "*.mi-nas-vaz.myqnapcloud.com"       # Wildcard para subdominios
      secretName: wildcard-mydominio-tls       # Debe existir; puedes generarlo o que cert-manager lo administre
  rules:
    # --- REGLA BASE: dominio principal QNAP -> indumentaria ---
    - host: mi-nas-vaz.myqnapcloud.com         # Sin wildcard; Ingress no admite * en spec.rules.host
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: maintenance-service     # Temporal: página de espera. Cambia a indumentaria-service cuando esté lista la app.
                port:
                  number: 80

    # --- REGLA ESPECIFICA: subdominio fijo para el SaaS ---
    - host: sistema.mi-nas-vaz.myqnapcloud.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: maintenance-service     # Temporal: página de espera. Cambia a saas-service cuando esté lista la app.
                port:
                  number: 80

    # --- REGLA CATCH-ALL: cualquier otro host/subdominio -> indumentaria ---
    # Deja host vacío para que Nginx capture cualquier Host header y lo envíe a la página de espera.
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: maintenance-service
                port:
                  number: 80
