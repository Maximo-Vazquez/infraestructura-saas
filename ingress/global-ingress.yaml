apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-principal
  namespace: default  # Cambia si usas otro namespace para los servicios
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"  # Permite uploads de hasta 10MB
    nginx.ingress.kubernetes.io/ssl-redirect: "true"    # Redirige HTTP->HTTPS cuando el secreto TLS existe
    cert-manager.io/cluster-issuer: letsencrypt-http
spec:
  ingressClassName: nginx  # Debe coincidir con la IngressClass del Nginx Ingress Controller instalado
  tls:
    - hosts:
        - mi-nas-vaz.myqnapcloud.com           # Host base expuesto por QNAP
        - sistema.mi-nas-vaz.myqnapcloud.com   # Subdominio fijo para SaaS
      secretName: wildcard-mydominio-tls       # Lo rellena cert-manager (Let's Encrypt)
  rules:
    # --- REGLA BASE: dominio principal QNAP -> indumentaria ---
    - host: mi-nas-vaz.myqnapcloud.com         # Sin wildcard; Ingress no admite * en spec.rules.host
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: maintenance-service     # Temporal: página de espera. Cambia a indumentaria-service cuando esté lista la app.
                port:
                  number: 80

    # --- REGLA ESPECIFICA: subdominio fijo para el SaaS ---
    - host: sistema.mi-nas-vaz.myqnapcloud.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: maintenance-service     # Temporal: página de espera. Cambia a saas-service cuando esté lista la app.
                port:
                  number: 80

    # --- REGLA CATCH-ALL: cualquier otro host/subdominio -> indumentaria ---
    # Deja host vacío para que Nginx capture cualquier Host header y lo envíe a la página de espera.
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: maintenance-service
                port:
                  number: 80
